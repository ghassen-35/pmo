<!DOCTYPE html>
<html dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

  <style>
    :root {
      --primary: #244961;
      --secondary: #ccaf87;
      --bg: #efe3d5;
      --white: #ffffff;
      --red: #d32f2f;
      --green: #28a745;
      --orange: #f39c12;
    }

    body {
      font-family: 'Tajawal', sans-serif;
      background-color: var(--bg);
      margin: 0;
      padding: 20px;
      color: var(--primary);
    }

    .header-area {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .back-btn {
      background: var(--primary);
      color: white;
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      transition: 0.3s;
    }
    .back-btn:hover { background: #1a3649; }

    .filter-bar {
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 30px;
    }

    .filter-group { display: flex; flex-direction: column; gap: 5px; }
    .filter-group label { font-size: 12px; font-weight: bold; }
    
    select, input[type="date"] {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: 'Tajawal';
      font-size: 14px;
    }

    button.apply-btn {
      background: var(--secondary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      height: 42px;
      margin-top: auto;
    }

    /* === ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø°Ø±ÙŠ Ù„Ù„ØªØ®Ø·ÙŠØ· Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø§Ù„ØªØµØ§Ù‚ === */
    .main-dashboard-grid {
      display: flex; /* Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙ„ÙŠÙƒØ³ Ù„Ù„Ø¬ÙˆØ§Ù„ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø³Ø§ÙØ§Øª */
      flex-direction: column;
      gap: 50px; /* Ù…Ø³Ø§ÙØ© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
      margin-bottom: 50px;
    }

    /* ÙÙŠ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ù†Ø¹ÙˆØ¯ Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø¨ÙƒØ© */
    @media (min-width: 992px) {
      .main-dashboard-grid {
        display: grid;
        grid-template-columns: 2fr 1fr; 
        gap: 30px;
        align-items: start;
      }
    }

    .side-charts-column {
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .chart-box {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      height: auto; /* Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø·ÙˆÙ„ Ø¨Ø§Ù„ØªÙ…Ø¯Ø¯ */
      position: relative;
      overflow: hidden; /* Ù„Ù…Ù†Ø¹ Ø£ÙŠ ØªØ¯Ø§Ø®Ù„ Ø®Ø§Ø±Ø¬ÙŠ */
    }

    .canvas-container {
      position: relative;
      width: 100%;
    }

    /* Ø§Ø±ØªÙØ§Ø¹Ø§Øª Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„Ø±Ø³ÙˆÙ… */
    .stacked-height { height: 725px; }
    .normal-height { height: 300px; }

    /* ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width: 768px) {
        .stacked-height { height: 450px; }
        .normal-height { height: 250px; }
    }

    h3 { text-align: center; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 16px; }

    .table-responsive {
      overflow-x: auto;
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-top: 30px;
    }
    table { width: 100%; border-collapse: collapse; min-width: 600px; text-align: center; }
    th { background: var(--primary); color: white; padding: 12px; }
    td { padding: 12px; border-bottom: 1px solid #eee; }
    
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .badge-high { background: #d4edda; color: #155724; }
    .badge-mid { background: #fff3cd; color: #856404; }
    .badge-low { background: #f8d7da; color: #721c24; }

  </style>
</head>
<body>

  <div class="header-area">
    <a href="index.html" class="back-btn">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø©</a>
    <h2>ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡</h2>
  </div>

  <div class="filter-bar">
    <div class="filter-group">
      <label>ÙØªØ±Ø© Ø³Ø±ÙŠØ¹Ø©</label>
      <select id="periodSelect" onchange="setPeriod()">
        <option value="all">ÙƒÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª</option>
        <option value="7">Ø¢Ø®Ø± Ø£Ø³Ø¨ÙˆØ¹</option>
        <option value="30" selected>Ø¢Ø®Ø± Ø´Ù‡Ø±</option>
        <option value="90">Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±</option>
        <option value="180">Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±</option>
        <option value="365">Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©</option>
      </select>
    </div>

    <div class="filter-group">
      <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
      <input type="date" id="dateStart">
    </div>

    <div class="filter-group">
      <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
      <input type="date" id="dateEnd">
    </div>

    <button class="apply-btn" onclick="fetchData()">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ± ğŸ”„</button>
  </div>

  <div id="loading" style="text-align:center; margin:50px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª... â³</div>

  <div id="reportContent" style="display:none;">
    
    <div class="main-dashboard-grid">
      
      <div class="chart-box">
        <h3>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ØªÙØµÙŠÙ„ÙŠ (Ù…ÙƒØ¯Ø³)</h3>
        <div class="canvas-container stacked-height">
           <canvas id="stackedChart"></canvas>
        </div>
      </div>

      <div class="side-charts-column">
        <div class="chart-box">
            <h3>ğŸ† Ø§Ù„Ø£ÙƒØ«Ø± Ø¥Ù†Ø¬Ø§Ø²Ø§Ù‹</h3>
            <div class="canvas-container normal-height">
               <canvas id="topEmployeeChart"></canvas>
            </div>
        </div>

        <div class="chart-box">
            <h3>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø¹Ø§Ù…</h3>
            <div class="canvas-container normal-height">
                <canvas id="rateChart"></canvas>
            </div>
        </div>
      </div>

    </div>

    <div class="table-responsive">
      <h3>ğŸ“‹ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</h3>
      <table id="dataTable">
        <thead>
          <tr>
            <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
            <th>âœ… Ù…Ù†Ø¬Ø² (ÙÙŠ Ø§Ù„ÙˆÙ‚Øª)</th>
            <th>âš ï¸ Ù…Ù†Ø¬Ø² (Ù…ØªØ£Ø®Ø±)</th>
            <th>â›” ÙØ§Ø¦ØªØ©</th>
            <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</th>
            <th>Ù…Ø¤Ø´Ø± Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… %</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <script>
    // ===========================================
    // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwlTkA2QV364oxl6bWZ90QYPwB1-fjPRua3TZteCWjq2fAIDS9IPuquV3bwsau5NjT1MQ/exec"; 
    // ===========================================

    Chart.register(ChartDataLabels);

    let myStackedChart = null;
    let myTopChart = null;
    let myRateChart = null;

    window.onload = function() {
      setPeriod(); 
      fetchData(); 
    };

    function setPeriod() {
      const select = document.getElementById('periodSelect');
      const val = select.value;
      const endInput = document.getElementById('dateEnd');
      const startInput = document.getElementById('dateStart');

      const today = new Date();
      endInput.valueAsDate = today;

      if (val === 'all') {
        startInput.value = '';
        endInput.value = '';
      } else {
        const pastDate = new Date();
        pastDate.setDate(today.getDate() - parseInt(val));
        startInput.valueAsDate = pastDate;
      }
    }

    function fetchData() {
      const start = document.getElementById('dateStart').value;
      const end = document.getElementById('dateEnd').value;
      
      document.getElementById('loading').style.display = 'block';
      document.getElementById('reportContent').style.display = 'none';

      const url = SCRIPT_URL + "?action=getReportData&start=" + start + "&end=" + end;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          document.getElementById('loading').style.display = 'none';
          document.getElementById('reportContent').style.display = 'block';
          renderDashboard(data);
        })
        .catch(err => {
          document.getElementById('loading').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±";
          console.error(err);
        });
    }

    function renderDashboard(data) {
      data.sort((a, b) => b.completedOnTime - a.completedOnTime);
      renderTable(data);
      renderCharts(data);
    }

    function renderTable(data) {
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';

      data.forEach(emp => {
        const totalDone = emp.completedOnTime + emp.completedLate;
        const totalDue = totalDone + emp.pendingLate;
        
        let rate = 0;
        if (totalDue > 0) {
          rate = Math.round((emp.completedOnTime / totalDue) * 100);
        }

        let badgeClass = 'badge-low';
        if (rate >= 80) { badgeClass = 'badge-high'; } 
        else if (rate >= 50) { badgeClass = 'badge-mid'; }

        const row = `
          <tr>
            <td style="font-weight:bold">${emp.name}</td>
            <td style="color:var(--green)">${emp.completedOnTime}</td>
            <td style="color:var(--orange)">${emp.completedLate}</td>
            <td style="color:var(--red)">${emp.pendingLate}</td>
            <td style="font-weight:bold">${totalDue}</td>
            <td><span class="badge ${badgeClass}">${rate}%</span></td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    function renderCharts(data) {
      const names = data.map(d => d.name);
      
      if (myStackedChart) { myStackedChart.destroy(); }
      if (myTopChart) { myTopChart.destroy(); }
      if (myRateChart) { myRateChart.destroy(); }

      const labelFont = { family: 'Tajawal', weight: 'bold', size: 11 };

      // 1. Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù…ÙƒØ¯Ø³
      const ctxStack = document.getElementById('stackedChart').getContext('2d');
      myStackedChart = new Chart(ctxStack, {
        type: 'bar',
        data: {
          labels: names,
          datasets: [
            {
              label: 'âœ… Ù…Ù†Ø¬Ø² ÙÙŠ Ø§Ù„ÙˆÙ‚Øª',
              data: data.map(d => d.completedOnTime),
              backgroundColor: '#28a745',
              barPercentage: 0.5,
            },
            {
              label: 'âš ï¸ ØªØ³Ù„ÙŠÙ… Ù…ØªØ£Ø®Ø±',
              data: data.map(d => d.completedLate),
              backgroundColor: '#f39c12',
              barPercentage: 0.5,
            },
            {
              label: 'â›” ÙØ§Ø¦ØªØ©',
              data: data.map(d => d.pendingLate),
              backgroundColor: '#d32f2f',
              barPercentage: 0.5,
            }
          ]
        },
        options: {
          indexAxis: 'x', 
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { bottom: 10 } }, 
          scales: {
            x: { 
              stacked: true,
              reverse: true,
              ticks: { font: { family: 'Tajawal', weight: 'bold' } }
            },
            y: { 
              stacked: true,
              position: 'right', 
              beginAtZero: true
            }
          },
          plugins: {
            legend: { rtl: true },
            tooltip: { rtl: true },
            // === ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù‡Ù†Ø§ ===
            datalabels: { display: false }
          }
        }
      });

      // 2. Ø±Ø³Ù… Ø§Ù„Ø£ÙƒØ«Ø± Ø¥Ù†Ø¬Ø§Ø²Ø§Ù‹
      const totalCompletedData = data.map(d => d.completedOnTime + d.completedLate);
      const ctxTop = document.getElementById('topEmployeeChart').getContext('2d');
      myTopChart = new Chart(ctxTop, {
        type: 'bar',
        data: {
          labels: names,
          datasets: [{
            label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†Ø¬Ø²',
            data: totalCompletedData,
            backgroundColor: '#244961',
            borderRadius: 5,
            barPercentage: 0.5,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { 
               reverse: true, 
               ticks: { font: { family: 'Tajawal', weight: 'bold' } }
            },
            y: { position: 'right' }
          },
          plugins: {
            legend: { display: false },
            tooltip: { rtl: true },
            datalabels: {
              anchor: 'end',
              align: 'top',
              color: '#244961',
              font: labelFont
            }
          }
        }
      });

// 3. Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ (Ù…Ø¹Ø¯Ù„: Ù…ÙØ§ØªÙŠØ­ Ù…Ø¯Ù…Ø¬Ø© ÙˆØ£ÙÙ‚ÙŠØ©)
      const totalOnTime = data.reduce((a, b) => a + b.completedOnTime, 0);
      const totalLateSub = data.reduce((a, b) => a + b.completedLate, 0);
      const totalPending = data.reduce((a, b) => a + b.pendingLate, 0);
      const grandTotal = totalOnTime + totalLateSub + totalPending;

      const ctxRate = document.getElementById('rateChart').getContext('2d');
      myRateChart = new Chart(ctxRate, {
        type: 'doughnut',
        data: {
          labels: ['ÙÙŠ Ø§Ù„ÙˆÙ‚Øª', 'ØªØ³Ù„ÙŠÙ… Ù…ØªØ£Ø®Ø±', 'ÙØ§Ø¦ØªØ©'],
          datasets: [{
            data: [totalOnTime, totalLateSub, totalPending],
            backgroundColor: ['#28a745', '#f39c12', '#d32f2f'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: 10 }, 
          plugins: {
            datalabels: { display: false },
            legend: { 
              position: 'bottom',
              labels: { 
                // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù‡Ù†Ø§ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙÙ‚ÙŠØ© ===
                font: { family: 'Tajawal', size: 11, weight: 'bold' }, // Ø®Ø· Ø£ØµØºØ± Ù‚Ù„ÙŠÙ„Ø§Ù‹
                boxWidth: 12, // Ù…Ø±Ø¨Ø¹ Ù„ÙˆÙ† ØµØºÙŠØ± Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙŠØ¶
                padding: 10,  // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„ØªÙ‚Ø±ÙŠØ¨Ù‡Ø§
                // ========================================
                generateLabels: (chart) => {
                  const data = chart.data;
                  if (data.labels.length && data.datasets.length) {
                    return data.labels.map((label, i) => {
                      const value = data.datasets[0].data[i];
                      const percentage = grandTotal > 0 ? Math.round((value / grandTotal) * 100) + '%' : '0%';
                      return {
                        text: label + ' (' + percentage + ')',
                        fillStyle: data.datasets[0].backgroundColor[i],
                        hidden: isNaN(data.datasets[0].data[i]) || chart.getDatasetMeta(0).data[i].hidden,
                        index: i
                      };
                    });
                  }
                  return [];
                }
              } 
            }
          }
        }
      });
    }
  </script>

</body>
</html>