<!DOCTYPE html>
<html dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-color: #244961;
      --secondary-color: #ccaf87;
      --bg-color: #efe3d5;
      --white: #ffffff;
      --gray: #d6dce2;
      --red-alert: #d32f2f;
      --green-done: #28a745;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Tajawal', sans-serif;
      background-color: var(--bg-color);
      margin: 0;
      padding: 0;
      color: var(--primary-color);
      padding-bottom: 50px;
    }

    .container {
      width: 90%;
      max-width: 600px;
      margin: 30px auto;
    }

    .header {
      background-color: var(--white);
      padding: 20px;
      text-align: center;
      border-bottom: 4px solid var(--secondary-color);
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .logo { height: 50px; width: auto; }

    h2 { margin: 0; font-size: 22px; font-weight: 800; }

    .input-group {
      background-color: var(--white);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      margin-bottom: 25px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    select {
      padding: 15px;
      border-radius: 8px;
      border: 2px solid var(--gray);
      width: 100%;
      font-size: 18px;
      text-align: center;
      background-color: #fff;
      cursor: pointer;
      font-family: 'Tajawal', sans-serif;
      outline: none;
    }
    select:focus { border-color: var(--secondary-color); }

    button.load {
      padding: 15px;
      background-color: var(--primary-color);
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      width: 100%;
      cursor: pointer;
      font-family: 'Tajawal', sans-serif;
      transition: background 0.3s;
    }
    button.load:hover { background-color: #1a3649; }

    .section-title {
      font-size: 18px;
      font-weight: bold;
      margin: 25px 0 10px 0;
      border-bottom: 2px solid var(--secondary-color);
      display: inline-block;
      padding-bottom: 5px;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
    .progress-wrapper {
      width: 80%;
      margin: 30px auto;
      text-align: center;
    }
    .progress-container {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 20px;
      height: 20px;
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
      margin-bottom: 10px;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--secondary-color) 0%, var(--primary-color) 100%);
      border-radius: 20px;
      transition: width 0.4s ease-in-out;
      box-shadow: 0 0 10px rgba(36, 73, 97, 0.3);
    }
    .progress-text {
      font-weight: bold;
      color: var(--primary-color);
      font-size: 16px;
    }
    .status-text {
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
      display: block;
    }

    /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
    .card {
      background: var(--white);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-right: 6px solid var(--primary-color);
      transition: all 0.3s ease;
    }
    .card-done { border-right-color: var(--green-done); background-color: #f0fff4; opacity: 0.8; }
    .card-done h3 { text-decoration: line-through; color: #888; }
    .card-late { border-right-color: var(--red-alert); background-color: #fff5f5; }
    
    .btn {
      background-color: var(--secondary-color);
      color: var(--white);
      border: none;
      padding: 12px;
      border-radius: 6px;
      width: 100%;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      font-family: 'Tajawal', sans-serif;
      margin-top: 10px;
    }

    @media (min-width: 800px) {
      .input-group { flex-direction: row; }
      select { width: 70%; }
      button.load { width: 30%; }
    }
  </style>
</head>
<body>

<div class="header">
    <div style="display:flex; justify-content:space-between; align-items:center; width:100%; direction: rtl;">
        
        <a href="report.html" style="text-decoration:none;">
            <button style="
                background: var(--secondary-color); 
                color: white; 
                border: none; 
                padding: 8px 15px; 
                border-radius: 8px; 
                font-family: 'Tajawal'; 
                font-weight: bold; 
                cursor: pointer;
                font-size: 14px;
                display: flex; align-items: center; gap: 5px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
            </button>
        </a>

        <div style="flex-grow:1; text-align:center;">
             <img src="logo.png" alt="Logo" class="logo" style="height:45px; vertical-align:middle;" onerror="this.style.display='none'"> 
             <h2 style="display:inline-block; vertical-align:middle; margin-right:10px;">Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù‡Ø§Ù… - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h2>
        </div>
        
        <div style="width: 80px;"></div> 

    </div>
  </div>

  <div class="container">
    <div class="input-group">
      <select id="empName">
        <option value="" disabled selected>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡...</option>
      </select>
      <button class="load" onclick="loadTasks()">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù…</button>
    </div>

    <div id="sectionToday" style="display:none;">
      <div class="section-title">ğŸ“… Ù…Ù‡Ø§Ù…ÙŠ Ø§Ù„ÙŠÙˆÙ…</div>
      <div id="todayList"></div>
    </div>

    <div id="sectionOther" style="display:none;">
      <div class="section-title">ğŸ“‹ Ù…Ù‡Ø§Ù… Ø£Ø®Ø±Ù‰ Ø¬Ø§Ø±ÙŠØ©</div>
      <div id="otherList"></div>
    </div>

    <div id="msgBox">
      <p style="text-align:center; margin-top:30px; font-size:16px;">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù…</p>
    </div>
  </div>

  <script>
    // ==========================================================
    // Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ø¢Ø®Ø± Ù†Ø³Ø®Ø©)
    // ==========================================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwlTkA2QV364oxl6bWZ90QYPwB1-fjPRua3TZteCWjq2fAIDS9IPuquV3bwsau5NjT1MQ/exec"; 

    window.onload = function() {
      fetch(SCRIPT_URL + "?action=getNames")
        .then(response => response.json())
        .then(names => {
          var select = document.getElementById("empName");
          select.innerHTML = '<option value="" disabled selected>ğŸ”½ Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ</option>';
          names.forEach(name => {
            var option = document.createElement("option");
            option.text = name;
            option.value = name;
            select.add(option);
          });
        })
        .catch(error => console.error("Error fetching names:", error));
    };

    function loadTasks() {
      var name = document.getElementById('empName').value;
      if(!name) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³Ù…");
      
      document.getElementById('sectionToday').style.display = 'none';
      document.getElementById('sectionOther').style.display = 'none';
      
      // 1. Ø¹Ø±Ø¶ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
      var loadingHtml = `
        <div class="progress-wrapper">
          <span class="status-text" id="statusText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª...</span>
          <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
          </div>
          <div class="progress-text" id="percentText">0%</div>
        </div>
      `;
      document.getElementById('msgBox').innerHTML = loadingHtml;

      // 2. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆÙ‡Ù…ÙŠ
      var width = 0;
      var progressBar = document.getElementById("progressBar");
      var percentText = document.getElementById("percentText");
      var statusText = document.getElementById("statusText");
      
      var progressInterval = setInterval(function() {
        if (width >= 30 && width < 70) {
           width += Math.random() * 2;
           statusText.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª...";
        } else if (width >= 70 && width < 90) {
           width += Math.random() * 0.5;
           statusText.innerText = "Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
        } else if (width < 90) {
           width += Math.random() * 5;
        }
        
        if (width > 90) width = 90;
        
        progressBar.style.width = width + "%";
        percentText.innerText = Math.round(width) + "%";
      }, 300);

      // 3. Ø·Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠ
      fetch(SCRIPT_URL + "?action=getTasks&name=" + encodeURIComponent(name))
        .then(response => response.json())
        .then(data => {
          clearInterval(progressInterval);
          
          progressBar.style.width = "100%";
          percentText.innerText = "100%";
          statusText.innerText = "ØªÙ… Ø§Ù„Ø¬Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!";
          
          setTimeout(function() {
            showTasks(data);
          }, 500);
        })
        .catch(error => {
          clearInterval(progressInterval);
          progressBar.style.backgroundColor = "var(--red-alert)";
          statusText.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„!";
          document.getElementById('msgBox').innerHTML = "<p style='color:red; text-align:center; padding:20px;'>Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>";
        });
    }

    function showTasks(tasks) {
      var todayContainer = document.getElementById('todayList');
      var otherContainer = document.getElementById('otherList');
      var msgBox = document.getElementById('msgBox');
      
      todayContainer.innerHTML = ""; otherContainer.innerHTML = ""; msgBox.innerHTML = "";

      if (tasks.length === 0) {
        msgBox.innerHTML = "<div style='text-align:center; padding:30px; background:#fff; border-radius:10px;'><h3 style='color:var(--secondary-color);'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…</h3><p>Ø³Ø¬Ù„Ùƒ Ù†Ø¸ÙŠÙ ØªÙ…Ø§Ù…Ø§Ù‹!</p></div>";
        return;
      }

      var hasToday = false; var hasOther = false;
      var todayActiveHtml = ""; var todayDoneHtml = ""; var otherHtml = "";

      tasks.forEach(function(t) {
        var html = createCard(t);
        if (t.section === "today") {
          hasToday = true;
          if (t.status === "ØªÙ…") todayDoneHtml += html; else todayActiveHtml += html;
        } else {
          hasOther = true; otherHtml += html;
        }
      });

      todayContainer.innerHTML = todayActiveHtml + todayDoneHtml;
      otherContainer.innerHTML = otherHtml;

      if(hasToday) document.getElementById('sectionToday').style.display = 'block';
      if(hasOther) document.getElementById('sectionOther').style.display = 'block';
    }

    function createCard(t) {
      var isDone = (t.status === "ØªÙ…");
      var cardClass = isDone ? 'card card-done' : (t.isLate ? 'card card-late' : 'card');
      var dateClass = t.isLate && !isDone ? 'date-val date-late' : 'date-val';
      var lateBadge = t.isLate && !isDone ? '<span style="color:var(--red-alert); font-size:12px; float:left;">âš ï¸ Ù…ØªØ£Ø®Ø±Ø©</span>' : '';
      
      var html = `<div class="${cardClass}" id="card-${t.row}">
        <h3><span>${t.task}</span>${lateBadge}</h3>`;
      
      if (!isDone) {
        html += `<span class="date-val ${t.isLate ? 'date-late' : ''}" style="display:block; margin-bottom:10px; font-weight:bold;">ğŸ“… Ø§Ù„Ù…ÙˆØ¹Ø¯: ${t.endDate}</span>`;
        html += `<button class="btn" onclick="markDone(this, ${t.row}, '${t.section}')">âœ… ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</button>`;
      } else {
         html += `<span style="color:var(--green-done); font-weight:bold; display:block; margin-top:10px;">âœ” ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span>`;
      }
      html += `</div>`;
      return html;
    }

    function markDone(btnElement, rowNum, section) {
      if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ")) return;
      btnElement.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
      btnElement.style.background = "#ccc";
      
      var form = new FormData();
      form.append('action', 'completeTask');
      form.append('row', rowNum);

      fetch(SCRIPT_URL, { method: 'POST', body: form })
        .then(response => response.json())
        .then(data => {
            var card = document.getElementById('card-' + rowNum);
            if (section === "today") {
              card.className = "card card-done";
              btnElement.style.display = 'none';
              card.innerHTML += `<span style="color:var(--green-done); font-weight:bold; display:block; margin-top:10px;">âœ” ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span>`;
              document.getElementById('todayList').appendChild(card);
            } else {
              card.style.display = "none";
            }
        });
    }
  </script>

</body>
</html>